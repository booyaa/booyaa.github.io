<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Code generation scripts in PL/SQL</title>
<link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-3dkvEK0WLHRJ7/Csr0BZjAWxERc5WH7bdeUya2aXxdU= sha512-+L4yy6FRcDGbXJ9mPG8MT/3UCDzwR9gPeyFNMCtInsol++5m3bk2bXWKdZjvybmohrAsn3Ua5x8gfLnbE1YkOg==" crossorigin="anonymous">
<link rel="stylesheet" href="//writ.cmcenroe.me/1.0.2/writ.min.css">
<link rel="stylesheet" href="/style.css" type="text/css" media="all" />
<link rel="alternate" href="/rss.xml" type="application/rss+xml" title="RSS" />
<meta name="author" content="Mark Sta Ana">
<meta name="description" content="Personal website of Mark Sta Ana, aged 7 3/4."/>
<meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" /> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-101141559-1', 'auto');
  ga('send', 'pageview');

</script>

  </head>
<body data-route=blog>
  <nav class="menu">
  <a class="menu-item " href="/about/">booyaa</a>
  <a class="menu-item current" href="/">blog</a>
  <a class="menu-item " href="/talks">talks</a>
  <a class="menu-item" href="/search/">search</a>
  <a class="menu-item" href="/archive/">archive</a>
  <a class="menu-item icon" href="http://github.com/booyaa"><i class="fa fa-github"></i></a>
  <a class="menu-item icon" href="http://twitter.com/booyaa"><i class="fa fa-twitter"></i></a>
  <a class="menu-item icon" href="/rss.xml"><i class="fa fa-rss"></i></a>
  <hr>
</nav>

  <main>
    <article>
      <h1>Code generation scripts in PL/SQL</h1>
       
      
      
      								
          
    	 

			<time pubdate="pubdate">May 10, 2017 - Reading time: 3 minutes.</time><br />
      
      <h2>Flattening XML paths</h2>
<p>The table <code>elephant_castle</code> has a <code>XMLTYPE</code> column <code>details</code> that we want to
get a list of distinct node paths.</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#b48ead;">WITH</span><span style="background-color:#2b303b;color:#c0c5ce;"> node_list </span><span style="background-color:#2b303b;color:#b48ead;">AS</span><span style="background-color:#2b303b;color:#c0c5ce;"> (
    </span><span style="background-color:#2b303b;color:#b48ead;">SELECT</span><span style="background-color:#2b303b;color:#c0c5ce;">
        x.*
    </span><span style="background-color:#2b303b;color:#b48ead;">FROM</span><span style="background-color:#2b303b;color:#c0c5ce;">
        elephant_castle ec
        </span><span style="background-color:#2b303b;color:#b48ead;">CROSS JOIN</span><span style="background-color:#2b303b;color:#c0c5ce;"> XMLTABLE ( 
&#39;</span><span style="background-color:#2b303b;color:#a3be8c;">declare function local:path-to-node( $nodes as node()* ) as xs:string* { 
    $nodes/string-join(ancestor-or-self::*/name(.),</span><span style="background-color:#2b303b;color:#96b5b4;">&#39;&#39;</span><span style="background-color:#2b303b;color:#a3be8c;">/</span><span style="background-color:#2b303b;color:#96b5b4;">&#39;&#39;</span><span style="background-color:#2b303b;color:#a3be8c;">) 
}
;for $i in $doc//*
    let $node_path := local:path-to-node($i)  
    (: still don</span><span style="background-color:#2b303b;color:#96b5b4;">&#39;&#39;</span><span style="background-color:#2b303b;color:#a3be8c;">t have a clue how this func works :)
    let $node_value := $i/text()
    where string-length($node_value) &gt; 0        
    (: how to exclude nodes without values :)

    return &lt;data&gt;
                &lt;path&gt;{$node_path}&lt;/path&gt;
                &lt;value&gt;{$node_value}&lt;/value&gt;
            &lt;/data&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;
                PASSING </span><span style="background-color:#2b303b;color:#d08770;">ec</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#d08770;">details </span><span style="background-color:#2b303b;color:#b48ead;">AS </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">doc</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot; COLUMNS
                    node_path </span><span style="background-color:#2b303b;color:#b48ead;">VARCHAR2</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#d08770;">4000</span><span style="background-color:#2b303b;color:#c0c5ce;">) </span><span style="background-color:#2b303b;color:#b48ead;">PATH </span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;</span><span style="background-color:#2b303b;color:#a3be8c;">path</span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;,
                    node_value </span><span style="background-color:#2b303b;color:#b48ead;">VARCHAR2</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#d08770;">4000</span><span style="background-color:#2b303b;color:#c0c5ce;">) </span><span style="background-color:#2b303b;color:#b48ead;">PATH </span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;</span><span style="background-color:#2b303b;color:#a3be8c;">value</span><span style="background-color:#2b303b;color:#c0c5ce;">&#39; </span><span style="background-color:#2b303b;color:#65737e;">/* debugging */</span><span style="background-color:#2b303b;color:#c0c5ce;">
            ) x
) </span><span style="background-color:#2b303b;color:#b48ead;">SELECT distinct </span><span style="background-color:#2b303b;color:#d08770;">nl</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#d08770;">node_path
</span><span style="background-color:#2b303b;color:#b48ead;">FROM</span><span style="background-color:#2b303b;color:#c0c5ce;">
    node_list nl;    
</span></pre>
<h2>Generate a query that combines existing fields with newly flatten XML paths</h2>
<p>This script allows you to apply boiler plate (fields from the existing table
using the data dictionary) and then make call out to another sqlplus script
that contains table specific mappings. The call out script is assumed to be
called <code>TableName.sql</code>.</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#c0c5ce;">REM Suppress all headings, page breaks, titles
SET PAGESIZE 0
REM Do not list the text of a command before and after replacing substitution 
REM variables with values
SET VERIFY OFF
REM  Do not display the number of records returned (when rows &gt;= n )
SET FEEDBACK OFF

CLEAR SCREEN

DEFINE TableName=STANDINGORDER
DEFINE TableAlias=so
DEFINE TableSchema=BPHADMIN

/*******************************************************************************
** Generate existing column list, excluding XMLTYPE, BLOB and CLOB types.
*******************************************************************************/
WITH column_list AS (
    SELECT
        column_id,
        column_name
    FROM
        all_tab_cols
    WHERE
        owner = &#39;&amp;TableSchema&#39;
    AND
        table_name = &#39;&amp;TableName&#39;
    AND
        data_type NOT IN (
            &#39;XMLTYPE&#39;,&#39;BLOB&#39;,&#39;CLOB&#39;
        )
    ORDER BY column_id
) SELECT
    CASE column_id  
        WHEN 1 THEN &#39;SELECT &amp;TableAlias&#39;|| &#39;.&#39; || column_name
        ELSE &#39;,&amp;TableAlias&#39;|| &#39;.&#39; || column_name
    END as sql
FROM
    column_list;

/*******************************************************************************
** Call out script with custom XML flattening logic (usually field name tweaks)
*******************************************************************************/
@&amp;TableName

/*******************************************************************************
** Add &quot;FROM&quot; statement
*******************************************************************************/
PROMPT FROM &amp;TableName &amp;TableAlias;;
</span></pre>
    </article>
    <br /><br />
    <a href="https://twitter.com/share" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </main>
  <footer>
  <hr>
  <p>
    <a href="/license/">CC BY-SA 4.0 / MIT</a>
    -
    <a href="https://github.com/cobalt-org/cobalt.rs">Built with Cobalt</a>
  </p>
  <br>
</footer>

</body>
</html>
