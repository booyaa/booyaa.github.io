<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>AWS DevOps Pro Certification Blog Post Series: Code Build</title>
<link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-3dkvEK0WLHRJ7/Csr0BZjAWxERc5WH7bdeUya2aXxdU= sha512-+L4yy6FRcDGbXJ9mPG8MT/3UCDzwR9gPeyFNMCtInsol++5m3bk2bXWKdZjvybmohrAsn3Ua5x8gfLnbE1YkOg==" crossorigin="anonymous">
<link rel="stylesheet" href="//writ.cmcenroe.me/1.0.2/writ.min.css">
<link rel="stylesheet" href="/style.css" type="text/css" media="all" />
<link rel="alternate" href="/rss.xml" type="application/rss+xml" title="RSS" />
<meta name="author" content="Mark Sta Ana">
<meta name="description" content="Personal website of Mark Sta Ana, aged 7 3/4."/>
<meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" /> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-101141559-1', 'auto');
  ga('send', 'pageview');

</script>

  </head>
<body data-route=blog>
  <nav class="menu">
  <a class="menu-item " href="/about/">booyaa</a>
  <a class="menu-item current" href="/">blog</a>
  <a class="menu-item " href="/talks">talks</a>
  <a class="menu-item" href="/search/">search</a>
  <a class="menu-item" href="/archive/">archive</a>
  <a class="menu-item icon" href="http://github.com/booyaa"><i class="fa fa-github"></i></a>
  <a class="menu-item icon" href="http://twitter.com/booyaa"><i class="fa fa-twitter"></i></a>
  <a class="menu-item icon" href="/rss.xml"><i class="fa fa-rss"></i></a>
  <hr>
</nav>

  <main>
    <article>
      <h1>AWS DevOps Pro Certification Blog Post Series: Code Build</h1>
       
      
      
      								
          
    	 

			<time pubdate="pubdate">Mar 27, 2019 - Reading time: 8 minutes.</time><br />
      
      <p><em>This is part of the blog post series: <a href="/2019/aws-devops-pro-certification-intro/">AWS DevOps Pro Certification</a></em></p>
<h2>Caveat emptor</h2>
<p>Using AWS costs money, some of these services may not be part of the AWS <a href="https://aws.amazon.com/free/">Free Tier</a>. You can keep costs down by tearing down anything you've created whilst learning, but it's still possible to run up a hefty bill so pay attention to the instances you setup!</p>
<p>I'm very lucky to be able to use my employer's AWS account. You should ask your place of work if a similar arrangement can be made as part of your study.</p>
<h2>Velocius quam asparagi conquantur</h2>
<p>The format of the blog posts is liable to change as I try refine my mental model of each domain, so be sure to revisit the blog posts on a regular basis.</p>
<h2>What?</h2>
<p>Code Build is a managed build service.</p>
<h2>Why?</h2>
<p>Asides the infrastructure required to host your applications and services, build farms are the next largest expenditure. Also orchestration to provision a build farm is non-trivial. Managed build services like Travis CI, Circle CI and Appveyor have helped Open Source projects thrive and allowed maintainers to support a wide range of CPU and operating systems.</p>
<h2>When?</h2>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#c0c5ce;">SDLC automation
~~~~~~~~~~~~~~~~

CodeCommit -&gt; [CodeBuild] -&gt; ???
</span></pre>
<h2>How?</h2>
<p>This is loosely based around the [Getting Started]https://docs.aws.amazon.com/codebuild/latest/userguide/getting-started.html) section of the User Guide.</p>
<p>The main differences are that I'm going to use the CLI instead of the Web UI to aid in learning these commands too, also I'm going to use Rust to demonstrate how to distribute build artefacts.</p>
<h3>Create S3</h3>
<p>We're going to use S3 to store our build artefacts, so we'll create a bucket in the same region as our CodeBuild project (<code>eu-west-2</code>). This is an important thing to note, as you can't use an S3 bucket in a different region to your CodeBuild project.</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#c0c5ce;"> s3api create-bucket \
</span><span style="background-color:#2b303b;color:#bf616a;">  --bucket</span><span style="background-color:#2b303b;color:#c0c5ce;"> hello-codebuild \
</span><span style="background-color:#2b303b;color:#bf616a;">  --region</span><span style="background-color:#2b303b;color:#c0c5ce;"> eu-west-2 \
</span><span style="background-color:#2b303b;color:#bf616a;">  --create-bucket-configuration</span><span style="background-color:#2b303b;color:#c0c5ce;"> LocationConstraint=eu-west-2
</span></pre>
<h3>Setup CodeCommit</h3>
<p>Next let's create a new CodeCommit repository to store our code.</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#c0c5ce;"> codecommit create-repository \
</span><span style="background-color:#2b303b;color:#bf616a;">  --repository-name</span><span style="background-color:#2b303b;color:#c0c5ce;"> hello-codebuild
  </span><span style="background-color:#2b303b;color:#8fa1b3;">--region</span><span style="background-color:#2b303b;color:#c0c5ce;"> eu-west-2
</span></pre>
<h3>Pull in the source code</h3>
<p>To avoid adding more steps (which aren't relevant), I've created a simple <a href="https://www.rust-lang.org/">Rust</a> app that'll we'll use for this lab.</p>
<p>Now we're going to do the following:</p>
<ul>
<li>clone the CodeCommit repo</li>
<li>download our sample app</li>
<li>unzip the sample app archive</li>
<li>do a bit of house keep to place the sample app at the right directory level, and remove the archive</li>
<li>push the code back up to the CodeCommit repo</li>
</ul>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#bf616a;">REPO_URL</span><span style="background-color:#2b303b;color:#c0c5ce;">=$</span><span style="background-color:#2b303b;color:#a3be8c;">(</span><span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#a3be8c;"> codecommit get-repository</span><span style="background-color:#2b303b;color:#bf616a;"> --repository-name </span><span style="background-color:#2b303b;color:#c0c5ce;">$</span><span style="background-color:#2b303b;color:#bf616a;">REPO_NAME </span><span style="background-color:#2b303b;color:#c0c5ce;">| </span><span style="background-color:#2b303b;color:#8fa1b3;">jq</span><span style="background-color:#2b303b;color:#bf616a;"> -r</span><span style="background-color:#2b303b;color:#a3be8c;"> .repositoryMetadata.cloneUrlSsh)
</span><span style="background-color:#2b303b;color:#8fa1b3;">git</span><span style="background-color:#2b303b;color:#c0c5ce;"> clone $</span><span style="background-color:#2b303b;color:#bf616a;">REPO_URL
</span><span style="background-color:#2b303b;color:#96b5b4;">cd</span><span style="background-color:#2b303b;color:#c0c5ce;"> hello-codebuild
</span><span style="background-color:#2b303b;color:#8fa1b3;">curl</span><span style="background-color:#2b303b;color:#bf616a;"> -sLO</span><span style="background-color:#2b303b;color:#c0c5ce;"> https://github.com/booyaa/hello-codebuild/archive/master.zip
</span><span style="background-color:#2b303b;color:#8fa1b3;">unzip</span><span style="background-color:#2b303b;color:#c0c5ce;"> master.zip
</span><span style="background-color:#2b303b;color:#8fa1b3;">rm</span><span style="background-color:#2b303b;color:#bf616a;"> -rf</span><span style="background-color:#2b303b;color:#c0c5ce;"> master.zip
</span><span style="background-color:#2b303b;color:#8fa1b3;">mv</span><span style="background-color:#2b303b;color:#c0c5ce;"> hello-codebuild-master/* .
</span><span style="background-color:#2b303b;color:#8fa1b3;">rm</span><span style="background-color:#2b303b;color:#bf616a;"> -rf</span><span style="background-color:#2b303b;color:#c0c5ce;"> hello-codebuild-master
</span><span style="background-color:#2b303b;color:#8fa1b3;">git</span><span style="background-color:#2b303b;color:#c0c5ce;"> add</span><span style="background-color:#2b303b;color:#bf616a;"> -A
</span><span style="background-color:#2b303b;color:#8fa1b3;">git</span><span style="background-color:#2b303b;color:#c0c5ce;"> commit</span><span style="background-color:#2b303b;color:#bf616a;"> -m </span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;</span><span style="background-color:#2b303b;color:#a3be8c;">initial commit</span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;
</span><span style="background-color:#2b303b;color:#8fa1b3;">git</span><span style="background-color:#2b303b;color:#c0c5ce;"> push</span><span style="background-color:#2b303b;color:#bf616a;"> -u</span><span style="background-color:#2b303b;color:#c0c5ce;"> origin master
</span></pre>
<h4>Build specification</h4>
<p>The <a href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html">build specification</a> is similar to other configuration files used by CI services, it tells the build service how to build our code.</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#bf616a;">version</span><span style="background-color:#2b303b;color:#c0c5ce;">: </span><span style="background-color:#2b303b;color:#d08770;">0.2

</span><span style="background-color:#2b303b;color:#bf616a;">phases</span><span style="background-color:#2b303b;color:#c0c5ce;">:
  </span><span style="background-color:#2b303b;color:#bf616a;">install</span><span style="background-color:#2b303b;color:#c0c5ce;">:
    </span><span style="background-color:#2b303b;color:#bf616a;">commands</span><span style="background-color:#2b303b;color:#c0c5ce;">:
      - </span><span style="background-color:#2b303b;color:#bf616a;">apt-get update -y
      </span><span style="background-color:#2b303b;color:#c0c5ce;">- </span><span style="background-color:#2b303b;color:#bf616a;">apt-get install -y build-essential
      </span><span style="background-color:#2b303b;color:#c0c5ce;">- </span><span style="background-color:#2b303b;color:#bf616a;">curl https://sh.rustup.rs -sSf | sh -s -- -y
      </span><span style="background-color:#2b303b;color:#c0c5ce;">- </span><span style="background-color:#2b303b;color:#bf616a;">PATH=/root/.cargo/bin:$PATH
  build</span><span style="background-color:#2b303b;color:#c0c5ce;">:
    </span><span style="background-color:#2b303b;color:#bf616a;">commands</span><span style="background-color:#2b303b;color:#c0c5ce;">:
      - </span><span style="background-color:#2b303b;color:#bf616a;">cargo test
      </span><span style="background-color:#2b303b;color:#c0c5ce;">- </span><span style="background-color:#2b303b;color:#bf616a;">cargo build --release
artifacts</span><span style="background-color:#2b303b;color:#c0c5ce;">:
  </span><span style="background-color:#2b303b;color:#bf616a;">files</span><span style="background-color:#2b303b;color:#c0c5ce;">:
    - </span><span style="background-color:#2b303b;color:#a3be8c;">./target/release/hello-codebuild
</span></pre>
<p>The points of interest for us, are the following sections or <a href="https://docs.aws.amazon.com/codebuild/latest/userguide/view-build-details.html#view-build-details-phases">phases</a>:</p>
<ul>
<li><code>install</code> - what commands do we need to run to install the build tools for our language. We're using <code>apt</code> because our CodeBuild project will use an Ubuntu 14.04 based server image.</li>
<li><code>build</code> - what commands are required to build the code</li>
<li><code>artifacts</code> - what do we want to upload to our S3 bucket?</li>
</ul>
<h3>Create a service role for CodeBuild</h3>
<p>Next we'll create a new service role (this is done for us if we create the project through UI), luckily the <a href="https://docs.aws.amazon.com/codebuild/latest/userguide/setting-up.html#setting-up-kms">User Guide</a> has instructions on how to do this through the CLI.</p>
<p>Let's create the following files:</p>
<p><code>create-role.json</code></p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#c0c5ce;">{
  &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Version</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">2012-10-17</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
  &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Statement</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: [
    {
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Effect</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Allow</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Principal</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: {
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Service</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">codebuild.amazonaws.com</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;
      },
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Action</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">sts:AssumeRole</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;
    }
  ]
}
</span></pre>
<p><code>put-role-policy.json</code></p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#c0c5ce;">{
  &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Version</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">2012-10-17</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
  &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Statement</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: [
    {
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Sid</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">CloudWatchLogsPolicy</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Effect</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Allow</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Action</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: [
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">logs:CreateLogGroup</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">logs:CreateLogStream</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">logs:PutLogEvents</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;
      ],
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Resource</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: [
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">*</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;
      ]
    },
    {
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Sid</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">CodeCommitPolicy</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Effect</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Allow</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Action</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: [
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">codecommit:GitPull</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;
      ],
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Resource</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: [
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">*</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;
      ]
    },
    {
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Sid</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">S3GetObjectPolicy</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Effect</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Allow</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Action</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: [
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">s3:GetObject</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">s3:GetObjectVersion</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;
      ],
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Resource</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: [
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">*</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;
      ]
    },
    {
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Sid</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">S3PutObjectPolicy</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Effect</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Allow</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;,
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Action</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: [
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">s3:PutObject</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;
      ],
      &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Resource</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;: [
        &quot;</span><span style="background-color:#2b303b;color:#a3be8c;">*</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;
      ]
    }
  ]
}
</span></pre>
<p>Let's run the following commands to create the Service Role.</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#c0c5ce;"> iam create-role \
</span><span style="background-color:#2b303b;color:#bf616a;">  --role-name</span><span style="background-color:#2b303b;color:#c0c5ce;"> CodeBuildServiceRole</span><span style="background-color:#2b303b;color:#bf616a;"> 
  --assume-role-policy-document</span><span style="background-color:#2b303b;color:#c0c5ce;"> file://create-role.json

</span><span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#c0c5ce;"> iam put-role-policy</span><span style="background-color:#2b303b;color:#bf616a;"> --role-name</span><span style="background-color:#2b303b;color:#c0c5ce;"> CodeBuildServiceRole \
</span><span style="background-color:#2b303b;color:#bf616a;">  --policy-name</span><span style="background-color:#2b303b;color:#c0c5ce;"> CodeBuildServiceRolePolicy \
</span><span style="background-color:#2b303b;color:#bf616a;">  --policy-document</span><span style="background-color:#2b303b;color:#c0c5ce;"> file://put-role-policy.json
</span></pre>
<p>Once we've created this Service Role, we can reference it for all for future CodeBuild projects.</p>
<h3>Create the CodeBuild project</h3>
<p>Finally we can create our CodeBuild project!</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#bf616a;">REPO_NAME</span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#a3be8c;">hello-codebuild
</span><span style="background-color:#2b303b;color:#bf616a;">S3_BUCKET</span><span style="background-color:#2b303b;color:#c0c5ce;">=$</span><span style="background-color:#2b303b;color:#bf616a;">REPO_NAME
SERVICE_ROLE_ARN</span><span style="background-color:#2b303b;color:#c0c5ce;">=$</span><span style="background-color:#2b303b;color:#a3be8c;">(</span><span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#a3be8c;"> iam get-role</span><span style="background-color:#2b303b;color:#bf616a;"> --role-name</span><span style="background-color:#2b303b;color:#a3be8c;"> CodeBuildServiceRole </span><span style="background-color:#2b303b;color:#c0c5ce;">| </span><span style="background-color:#2b303b;color:#8fa1b3;">jq</span><span style="background-color:#2b303b;color:#bf616a;"> -r</span><span style="background-color:#2b303b;color:#a3be8c;"> .Role.Arn)
</span><span style="background-color:#2b303b;color:#bf616a;">REPO_URL</span><span style="background-color:#2b303b;color:#c0c5ce;">=$</span><span style="background-color:#2b303b;color:#a3be8c;">(</span><span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#a3be8c;"> codecommit get-repository</span><span style="background-color:#2b303b;color:#bf616a;"> --repository-name </span><span style="background-color:#2b303b;color:#c0c5ce;">$</span><span style="background-color:#2b303b;color:#bf616a;">REPO_NAME </span><span style="background-color:#2b303b;color:#c0c5ce;">| </span><span style="background-color:#2b303b;color:#8fa1b3;">jq</span><span style="background-color:#2b303b;color:#bf616a;"> -r</span><span style="background-color:#2b303b;color:#a3be8c;"> .repositoryMetadata.cloneUrlHttp)
</span><span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#c0c5ce;"> codebuild create-project \
</span><span style="background-color:#2b303b;color:#bf616a;">  --name </span><span style="background-color:#2b303b;color:#c0c5ce;">$</span><span style="background-color:#2b303b;color:#bf616a;">REPO_NAME </span><span style="background-color:#2b303b;color:#c0c5ce;">\
</span><span style="background-color:#2b303b;color:#bf616a;">  --source</span><span style="background-color:#2b303b;color:#c0c5ce;"> type=CODECOMMIT,location=$</span><span style="background-color:#2b303b;color:#bf616a;">REPO_URL </span><span style="background-color:#2b303b;color:#c0c5ce;">\
</span><span style="background-color:#2b303b;color:#bf616a;">  --artifacts</span><span style="background-color:#2b303b;color:#c0c5ce;"> type=S3,location=$</span><span style="background-color:#2b303b;color:#bf616a;">S3_BUCKET </span><span style="background-color:#2b303b;color:#c0c5ce;">\
</span><span style="background-color:#2b303b;color:#bf616a;">  --environment</span><span style="background-color:#2b303b;color:#c0c5ce;"> type=LINUX_CONTAINER,image=aws/codebuild/ubuntu-base:14.04,computeType=BUILD_GENERAL1_SMALL,imagePullCredentialsType=CODEBUILD \
</span><span style="background-color:#2b303b;color:#bf616a;">  --service-role </span><span style="background-color:#2b303b;color:#c0c5ce;">$</span><span style="background-color:#2b303b;color:#bf616a;">SERVICE_ROLE_ARN
</span></pre>
<p>Key parameters/switches to point out:</p>
<ul>
<li><code>source</code> 
<ul>
<li>We've opted for the CodeCommit <code>type</code>, but there are also options for BitBucket, CodePipeline, GitHub, S3 and finally No Source (when there's no source code). </li>
<li>The other parameter we provided was the <code>location</code> of the Git repo URL. </li>
<li>More details about the <code>sourceType</code> can be found in the <a href="https://docs.aws.amazon.com/codebuild/latest/APIReference/API_ProjectSource.html">API</a>.</li>
</ul>
</li>
<li><code>artifacts</code> 
<ul>
<li>We've opted for the <code>type</code> S3, the only other options are CodePipeline and No artifacts. </li>
<li>The other parameter we provided was the <code>location</code> of the S3 bucket. </li>
<li>More details about the <code>artifacts</code> can be found in the <a href="https://docs.aws.amazon.com/codebuild/latest/APIReference/API_ProjectArtifacts.html">API</a></li>
</ul>
</li>
<li><code>environment</code> 
<ul>
<li>The image <code>type</code> is Linux, instead of Windows. </li>
<li>The <code>image</code> is Ubuntu 14.04 base (which looks like the only choice if you go through the UI). </li>
<li>The <code>computeType</code> is the smallest general purpose build server</li>
<li>The <code>imagePullCredentialsType</code> is AWS CodeBuild's own credentials to pull the image, which is fine since the Container Registry we're using is the one provided by AWS for it's own images.</li>
</ul>
</li>
<li><code>service-role</code> is the ARN of the IAM role that we created earlier.</li>
</ul>
<h3>Run build</h3>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#bf616a;">BUILD_ID</span><span style="background-color:#2b303b;color:#c0c5ce;">=$</span><span style="background-color:#2b303b;color:#a3be8c;">(</span><span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#a3be8c;"> codebuild start-build</span><span style="background-color:#2b303b;color:#bf616a;"> --project-name </span><span style="background-color:#2b303b;color:#c0c5ce;">$</span><span style="background-color:#2b303b;color:#bf616a;">REPO_NAME </span><span style="background-color:#2b303b;color:#c0c5ce;">| </span><span style="background-color:#2b303b;color:#8fa1b3;">jq</span><span style="background-color:#2b303b;color:#bf616a;"> -r</span><span style="background-color:#2b303b;color:#a3be8c;"> .build.id)
</span></pre>
<h3>View build logs</h3>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#c0c5ce;"> codebuild batch-get-builds</span><span style="background-color:#2b303b;color:#bf616a;"> --ids </span><span style="background-color:#2b303b;color:#c0c5ce;">$</span><span style="background-color:#2b303b;color:#bf616a;">BUILD_ID
</span></pre>
<h3>Get artifact and test it</h3>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#c0c5ce;"> s3 cp s3://hello-codebuild/hello-codebuild/target/release/hello-codebuild hello-codebuild
</span><span style="background-color:#2b303b;color:#8fa1b3;">chmod</span><span style="background-color:#2b303b;color:#c0c5ce;"> +x
</span><span style="background-color:#2b303b;color:#8fa1b3;">docker</span><span style="background-color:#2b303b;color:#c0c5ce;"> run</span><span style="background-color:#2b303b;color:#bf616a;"> --rm -it -v </span><span style="background-color:#2b303b;color:#c0c5ce;">$</span><span style="background-color:#2b303b;color:#bf616a;">PWD</span><span style="background-color:#2b303b;color:#c0c5ce;">:/root ubuntu bash</span><span style="background-color:#2b303b;color:#bf616a;"> -c</span><span style="background-color:#2b303b;color:#c0c5ce;"> /root/hello-codebuild
</span></pre>
<h3>Clean up</h3>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#c0c5ce;"> codebuild delete-project</span><span style="background-color:#2b303b;color:#bf616a;"> --name</span><span style="background-color:#2b303b;color:#c0c5ce;"> hello-codebuild
</span><span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#c0c5ce;"> codecommit delete-repository</span><span style="background-color:#2b303b;color:#bf616a;"> --repository-name</span><span style="background-color:#2b303b;color:#c0c5ce;"> hello-codebuild
</span><span style="background-color:#2b303b;color:#8fa1b3;">aws</span><span style="background-color:#2b303b;color:#c0c5ce;"> s3api delete-bucket</span><span style="background-color:#2b303b;color:#bf616a;"> --bucket</span><span style="background-color:#2b303b;color:#c0c5ce;"> hello-codebuild
</span></pre>
<p>You could remove the Service Role, but it might be handy if you plan to do some more practice sessions with this lab.</p>
<h2>API and CLI features and verbs</h2>
<h3>Features</h3>
<ul>
<li>Project(s)</li>
<li>Build(s)</li>
<li>Webhook</li>
<li>Source Credentials</li>
</ul>
<h3>Verbs (CRUD)</h3>
<ul>
<li>create</li>
<li>batch-get/get/list/describe</li>
<li>update/put</li>
<li>delete</li>
</ul>
<h3>Outliers</h3>
<ul>
<li>list-curated-environment-images</li>
<li>import-source-credentials</li>
<li>invalidate-project-cache</li>
<li>stop/start build</li>
</ul>
<p><strong>AWS DevOps Pro Certification Blog Post Series</strong></p>
<ul>
<li><a href="/2019/aws-devops-pro-certification-intro/">Intro</a></li>
<li>Domain 1: <a href="/2019/aws-devops-pro-certification-sdlc-intro/">SDLC automation</a>
<ul>
<li><a href="/2019/aws-devops-pro-certification-code-commit/">Code Commit</a></li>
<li>Code Build</li>
<li><a href="/2019/aws-devops-pro-certification-code-deploy/">Code Deploy</a></li>
<li><a href="/2019/aws-devops-pro-certification-code-pipeline">Code Pipeline</a></li>
</ul>
</li>
<li>Domain 2: Configuration Management and Infrastructure as Code</li>
<li>Domain 3: Monitoring and Logging</li>
<li>Domain 4: Policies and Standards Automation</li>
<li>Domain 5: Incident and Event Response</li>
<li>Domain 6: High Availability, Fault Tolerance, and Disaster Recovery</li>
</ul>

    </article>
    <br /><br />
    <a href="https://twitter.com/share" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </main>
  <footer>
  <hr>
  <p>
    <a href="/license/">CC BY-SA 4.0 / MIT</a>
    -
    <a href="https://github.com/cobalt-org/cobalt.rs">Built with Cobalt</a>
  </p>
  <br>
</footer>

</body>
</html>
