<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Adding missing functionality to Terraform</title>
<link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-3dkvEK0WLHRJ7/Csr0BZjAWxERc5WH7bdeUya2aXxdU= sha512-+L4yy6FRcDGbXJ9mPG8MT/3UCDzwR9gPeyFNMCtInsol++5m3bk2bXWKdZjvybmohrAsn3Ua5x8gfLnbE1YkOg==" crossorigin="anonymous">
<link rel="stylesheet" href="//writ.cmcenroe.me/1.0.2/writ.min.css">
<link rel="stylesheet" href="/style.css" type="text/css" media="all" />
<link rel="alternate" href="/rss.xml" type="application/rss+xml" title="RSS" />
<meta name="author" content="Mark Sta Ana">
<meta name="description" content="Personal website of Mark Sta Ana, aged 7 3/4."/>
<meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" /> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-101141559-1', 'auto');
  ga('send', 'pageview');

</script>

  </head>
<body data-route=blog>
  <nav class="menu">
  <a class="menu-item " href="/about/">booyaa</a>
  <a class="menu-item current" href="/">blog</a>
  <a class="menu-item " href="/talks">talks</a>
  <a class="menu-item" href="/search/">search</a>
  <a class="menu-item" href="/archive/">archive</a>
  <a class="menu-item icon" href="http://github.com/booyaa"><i class="fa fa-github"></i></a>
  <a class="menu-item icon" href="http://twitter.com/booyaa"><i class="fa fa-twitter"></i></a>
  <a class="menu-item icon" href="/rss.xml"><i class="fa fa-rss"></i></a>
  <hr>
</nav>

  <main>
    <article>
      <h1>Adding missing functionality to Terraform</h1>
       
      
      
      								
          
    	 

			<time pubdate="pubdate">Oct 27, 2019 - Reading time: 2 minutes.</time><br />
      
      <p>I needed to codify the creation of PostgreSQL read replicas, so I did a bit of research around ways I could do this quickly without diving into the Terraform <a href="https://www.terraform.io/docs/providers/azurerm/">provider</a>.</p>
<p>The quickest way to do this was to:</p>
<ul>
<li>use the <a href="https://www.terraform.io/docs/provisioners/local-exec.html"><code>local-exec</code></a> provisioner to invoke the Azure CLI commands (details to follow)</li>
<li>wrap the code in a module (to allow for reuse and share with the community)</li>
</ul>
<p>The Azure <a href="https://docs.microsoft.com/en-us/azure/postgresql/howto-read-replicas-cli">docs</a> requires the following steps to be carried out to create a read replica using the Azure CLI are:</p>
<ul>
<li>Enable replication support on the primary server</li>
<li>Restart the primary server (for the changes to take effect)</li>
<li>Create the replica using the primary server as the source</li>
</ul>
<p>Caveat emptor: as the Terraform docs <a href="https://www.terraform.io/docs/provisioners/local-exec.html">mention</a>, provisioners are a last resort. A major downside of using this method to add missing functionality is that there's no state tracking, i.e. if you make a change to the resource, Terraform won't know about it.</p>
<p>Here's the essence of the code (I've omitted certain details for brevity the full code is on <a href="https://github.com/booyaa/terraform-azurerm-postgresql-read-replica">GitHub</a>):</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#c0c5ce;">resource &quot;null_resource&quot; &quot;postgresql-read-replica&quot; {
  triggers = {
    resource_group_name            = var.resource_group_name
    postgresql_primary_server_name = var.postgresql_primary_server_name
    postgresql_replica_server_name = var.postgresql_replica_server_name
  }
</span></pre>
<p>The <a href="https://www.terraform.io/docs/providers/null/resource.html"><code>null_resource</code></a> is also provisioner is used as a container for the <code>local_exec</code> calls. The <code>triggers</code> block allows the resource to be replaced, i.e. destroyed and recreated when the resource group, the PostgreSQL primary or replica server names changes.</p>
<p>You can already see that <a href="https://www.terraform.io/docs/modules/index.html">modules</a> are just ordinary bits of Terraform code.</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#c0c5ce;">  provisioner &quot;local-exec&quot; {
    command = &lt;&lt;ENABLE_REPLICATION
az postgres server configuration set \
...
ENABLE_REPLICATION
  }

  provisioner &quot;local-exec&quot; {
    command = &lt;&lt;RESTART_SERVER
az postgres server restart \
...
RESTART_SERVER
  }

  provisioner &quot;local-exec&quot; {
    command = &lt;&lt;CREATE_REPLICA
az postgres server replica create \
...
CREATE_REPLICA
  }
</span></pre>
<p>These three provisioner blocks perform the required actions to create a read replica using the Azure CLI. To avoid having to escape quotes we're using the <a href="https://en.wikipedia.org/wiki/Here_document">here doc</a> notation.</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#c0c5ce;">  provisioner &quot;local-exec&quot; {
    when = &quot;destroy&quot;
    command = &lt;&lt;DESTROY_REPLICA
az postgres server delete \
  --name ${var.postgresql_replica_server_name} \
  --resource-group ${var.resource_group_name} \
  --yes
DESTROY_REPLICA
  }
}
</span></pre>
<p>Finally, we handle when what to do when the replica is destroyed.</p>
<p>I've uploaded the module to the Terraform <a href="https://registry.terraform.io/modules/booyaa/postgresql-read-replica/azurerm/0.2.0">registry</a> which means the module can be easily referenced just like another resource:</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#c0c5ce;">module demo-replica {
  source                         = &quot;booyaa/terraform-azurerm-postgresql-read-replica&quot;
  resource_group_name            = azurerm_resource_group.demo.name
  postgresql_primary_server_name = azurerm_postgresql_server.demo.name
  postgresql_replica_server_name = &quot;${azurerm_postgresql_server.demo.name}-replica&quot;
}
</span></pre>
<p>Just like the <a href="https://www.terraform.io/docs/configuration/data-sources.html">Data Sources</a>, modules can be used as a reference so we can now apply a firewall rule against the read replica:</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#c0c5ce;">resource &quot;azurerm_postgresql_firewall_rule&quot; &quot;demo-replica&quot; {
  name                = &quot;office&quot;
  resource_group_name = azurerm_resource_group.demo.name
  server_name         = module.demo-replica.replica_name
  start_ip_address    = &quot;8.8.8.8&quot;
  end_ip_address      = &quot;8.8.8.8&quot;

  depends_on = [module.demo-replica]
}
</span></pre><!-- links -->

    </article>
    <br /><br />
    <a href="https://twitter.com/share" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </main>
  <footer>
  <hr>
  <p>
    <a href="/license/">CC BY-SA 4.0 / MIT</a>
    -
    <a href="https://github.com/cobalt-org/cobalt.rs">Built with Cobalt</a>
  </p>
  <br>
</footer>

</body>
</html>
